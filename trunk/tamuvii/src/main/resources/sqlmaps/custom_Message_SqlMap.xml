<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="custom_message" >
  
   <resultMap id="userMessageListItem" class="com.tamuvii.pojo.MessageUserItem">
        <result property="message.message" column="message"/>
        <result property="message.sender" column="sender"/>
        <result property="message.receiver" column="receiver"/>
        <result property="message.messagetext" column="messagetext"/>
        <result property="message.dateadded" column="dateadded"/>
		<result property="user.id" column="idUser"/>
        <result property="user.username" column="usernameUser"/>
		<result property="user.email" column="emailUser"/>
        <result property="user.website" column="websiteUser"/>
        <result property="user.websiteTitle" column="websiteTitleUser"/>
        <result property="user.address.city" column="cityUser"/>
        <result property="user.address.country" column="countryUser"/>
        <result property="user.imageLink" column="imageLinkUser"/>
        <result property="receiver.id" column="idReceiver"/>
        <result property="receiver.username" column="usernameReceiver"/>
		<result property="receiver.email" column="emailReceiver"/>
        <result property="receiver.website" column="websiteReceiver"/>
        <result property="receiver.websiteTitle" column="websiteTitleReceiver"/>
        <result property="receiver.address.city" column="cityReceiver"/>
        <result property="receiver.address.country" column="countryReceiver"/>
        <result property="receiver.imageLink" column="imageLinkReceiver"/>
        <result property="numMessages" column="numMessages"/>
   </resultMap>

  <select id="getGroupedMessagesByUser" resultMap="userMessageListItem" parameterClass="java.lang.String" >
  		select			m.message, 
						m.sender,
						m.receiver,
						m.message_text as messagetext,
						m.date_added as dateadded,
						u.id as idUser,
						u.username as usernameUser, 
						u.email as emailUser,
						u.website as websiteUser,
						u.website_title as websiteTitleUser,
						u.city as cityUser,
						u.country as countryUser,
						u.image as imageLinkUser,
						null as idReceiver,
						null as usernameReceiver, 
						null as emailReceiver,
						null as websiteReceiver,
						null as websiteTitleReceiver,
						null as cityReceiver,
						null as countryReceiver,
						null as imageLinkReceiver,
						count(m.message) as numMessages

		from			message m inner join app_user u
						on m.receiver = u.username
		
		where			m.sender = #username#
		group by		m.receiver
  </select>
  
  <select id="getInMessagesByUser" resultMap="userMessageListItem" parameterClass="java.lang.String" >
  		select			m.message, 
						m.sender,
						m.receiver,
						m.message_text as messagetext,
						m.date_added as dateadded,
						au.id as idUser,
						au.username as usernameUser, 
						au.email as emailUser,
						au.website as websiteUser,
						au.website_title as websiteTitleUser,
						au.city as cityUser,
						au.country as countryUser,
						au.image as imageLinkUser,
						au2.id as idReceiver,
						au2.username as usernameReceiver, 
						au2.email as emailReceiver,
						au2.website as websiteReceiver,
						au2.website_title as websiteTitleReceiver,
						au2.city as cityReceiver,
						au2.country as countryReceiver,
						au2.image as imageLinkReceiver,
						0 as numMessages
	
		from			message m inner join app_user au
						on m.sender = au.username inner join app_user au2
						on m.receiver = au2.username
		
		where			m.sender = #username# or m.receiver = #username#
		
		group by		m.sender, m.receiver
		order by		dateadded desc
		
		limit 0, 10
  </select>
  
  <select id="getConversationWithUser" resultMap="userMessageListItem" parameterClass="com.tamuvii.pojo.queryfilter.MessageUserFilter" >
  		select			m.message, 
						m.sender,
						m.receiver,
						m.message_text as messagetext,
						m.date_added as dateadded,
						au.id as idUser,
						au.username as usernameUser, 
						au.email as emailUser,
						au.website as websiteUser,
						au.website_title as websiteTitleUser,
						au.city as cityUser,
						au.country as countryUser,
						au.image as imageLinkUser,
						au2.id as idReceiver,
						au2.username as usernameReceiver, 
						au2.email as emailReceiver,
						au2.website as websiteReceiver,
						au2.website_title as websiteTitleReceiver,
						au2.city as cityReceiver,
						au2.country as countryReceiver,
						au2.image as imageLinkReceiver,
						0 as numMessages
						
		from			message m inner join app_user au
						on m.sender = au.username inner join app_user au2
						on m.receiver = au2.username
		
		where			(m.sender = #remoteUser# and m.receiver = #username#) or (m.receiver = #remoteUser# and m.sender = #username#)
		order by		dateadded		desc
  </select>
  
  <!-- select id="getConversationWithUser" resultMap="userMessageListItem" parameterClass="com.tamuvii.pojo.queryfilter.MessageUserFilter" >
  		select			m.message, 
						m.sender,
						m.receiver,
						m.message_text as messagetext,
						m.date_added as dateadded,
						u.id,
						u.username, 
						u.email,
						u.website,
						u.website_title as websiteTitle,
						u.city,
						u.country,
						u.image as imageLink,
						0 as numMessages

		from			message m inner join app_user u
						on m.sender = u.username
		
		where			(m.sender = #remoteUser# and m.receiver = #username#) or (m.receiver = #remoteUser# and m.sender = #username#)
		order by		dateadded		desc
  </select-->
  
</sqlMap>